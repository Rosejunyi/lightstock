name: Daily-aliyun-StockData-V3

# è§¦å‘æ–¹å¼
on:
  # 1. å®šæ—¶è‡ªåŠ¨è¿è¡Œ (æ¯ä¸ªäº¤æ˜“æ—¥æ”¶ç›˜å)
  schedule:
    # åŒ—äº¬æ—¶é—´ å‘¨ä¸€åˆ°å‘¨äº” 16:30 (UTC 08:30)
    - cron: '30 8 * * 1-5'
  
  # 2. æ‰‹åŠ¨ä¸€é”®è§¦å‘
  workflow_dispatch:

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.10'
  SERVER_PATH: '/root/lightstock'
  CHECK_SERVER: 'true'  # æ˜¯å¦æ£€æŸ¥æœåŠ¡å™¨æ•°æ®çŠ¶æ€

jobs:
  update-stock-data:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # æ­¥éª¤2: è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # æ­¥éª¤3: å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install baostock pandas pyarrow tqdm
      
      # æ­¥éª¤4: é…ç½®SSH (æå‰é…ç½®ï¼Œä¾›è„šæœ¬æ£€æµ‹æœåŠ¡å™¨ä½¿ç”¨)
      - name: ğŸ”‘ é…ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          
          # æµ‹è¯•SSHè¿æ¥
          echo "æµ‹è¯•SSHè¿æ¥..."
          ssh -i ~/.ssh/id_rsa -o ConnectTimeout=10 \
            root@${{ secrets.SERVER_IP }} "echo 'âœ… SSHè¿æ¥æˆåŠŸ'" || \
            echo "âš ï¸ SSHè¿æ¥å¤±è´¥ï¼Œå°†è·³è¿‡æœåŠ¡å™¨æ£€æµ‹"
      
      # æ­¥éª¤5: æ™ºèƒ½æ›´æ–°æ•°æ® (V3ç‰ˆæœ¬)
      - name: ğŸ“Š æ™ºèƒ½æ›´æ–°æ•°æ® (V3)
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PATH: ${{ env.SERVER_PATH }}
          CHECK_SERVER: ${{ env.CHECK_SERVER }}
        run: |
          echo "========================================"
          echo "  å¼€å§‹æ™ºèƒ½æ›´æ–°è‚¡ç¥¨æ•°æ® V3"
          echo "========================================"
          echo ""
          echo "V3ç‰ˆæœ¬ç‰¹æ€§:"
          echo "  âœ… è‚¡ç¥¨æ–‡ä»¶: çº¯æ•°å­—å‘½å (å¦‚ 000001.parquet)"
          echo "  âœ… æŒ‡æ•°æ–‡ä»¶: å®Œæ•´æ ¼å¼ (å¦‚ sh.000001.parquet)"
          echo "  âœ… ä¼˜å…ˆæ£€æµ‹é˜¿é‡Œäº‘æœåŠ¡å™¨æ•°æ®çŠ¶æ€"
          echo "  âœ… æ•°æ®å·²æœ€æ–°åˆ™è‡ªåŠ¨è·³è¿‡æ›´æ–°"
          echo "  âœ… éœ€è¦æ›´æ–°æ—¶å‘å‰æ¨3å¤©ç¡®ä¿å®Œæ•´æ€§"
          echo ""
          
          # è¿è¡ŒV3ç‰ˆæœ¬æ›´æ–°è„šæœ¬
          python scripts/download_data_smart.py
          
          echo ""
          echo "âœ… æ›´æ–°æµç¨‹å®Œæˆ!"
      
      # æ­¥éª¤6: ä¸Šä¼ åˆ°é˜¿é‡Œäº‘
      - name: ğŸ“¤ ä¸Šä¼ åˆ°é˜¿é‡Œäº‘
        run: |
          echo "========================================"
          echo "  ä¸Šä¼ æ•°æ®åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨"
          echo "========================================"
          echo "æœåŠ¡å™¨: ${{ secrets.SERVER_IP }}"
          echo "è·¯å¾„: ${{ env.SERVER_PATH }}/data/daily_parquet/"
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦ä¸Šä¼ 
          file_count=$(ls -1 data/daily_parquet/*.parquet 2>/dev/null | wc -l)
          
          if [ "$file_count" -eq 0 ]; then
            echo "â„¹ï¸  æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆæ•°æ®å¯èƒ½å·²æ˜¯æœ€æ–°ï¼‰"
          else
            echo "ğŸ“¦ å‡†å¤‡ä¸Šä¼  $file_count ä¸ªæ–‡ä»¶..."
            
            # ä¸Šä¼ æ‰€æœ‰parquetæ–‡ä»¶
            scp -i ~/.ssh/id_rsa -r \
              data/daily_parquet/*.parquet \
              root@${{ secrets.SERVER_IP }}:${{ env.SERVER_PATH }}/data/daily_parquet/
            
            echo ""
            echo "âœ… ä¸Šä¼ å®Œæˆ! ($file_count ä¸ªæ–‡ä»¶)"
          fi
      
      # æ­¥éª¤7: éªŒè¯æœåŠ¡å™¨æ•°æ®
      - name: âœ… éªŒè¯æœåŠ¡å™¨æ•°æ®
        run: |
          echo "========================================"
          echo "  éªŒè¯æœåŠ¡å™¨ç«¯æ•°æ®"
          echo "========================================"
          echo ""
          
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} '
            cd '"$SERVER_PATH"'/data/daily_parquet/
            
            echo "ğŸ“Š æ•°æ®ç»Ÿè®¡:"
            echo "  æ–‡ä»¶æ€»æ•°: $(ls -1 *.parquet 2>/dev/null | wc -l)"
            echo "  æ€»å¤§å°: $(du -sh . | cut -f1)"
            echo ""
            
            # ç»Ÿè®¡ä¸åŒç±»å‹æ–‡ä»¶
            pure=$(ls *.parquet 2>/dev/null | grep -E "^[0-9]+\.parquet$" | wc -l)
            prefix=$(ls *.parquet 2>/dev/null | grep -E "^(sh|sz)\.[0-9]+\.parquet$" | wc -l)
            
            echo "ğŸ“ æ–‡ä»¶åˆ†ç±»:"
            echo "  è‚¡ç¥¨æ–‡ä»¶(çº¯æ•°å­—): $pure"
            echo "  æŒ‡æ•°æ–‡ä»¶(å¸¦å‰ç¼€): $prefix"
            echo ""
            
            echo "ğŸ“… æœ€æ–°æ›´æ–°çš„æ–‡ä»¶ç¤ºä¾‹:"
            ls -lt *.parquet 2>/dev/null | head -6
            echo ""
            
            # æ£€æŸ¥æŒ‡æ•°æ–‡ä»¶
            echo "ğŸ” æ ¸å¿ƒæŒ‡æ•°æ–‡ä»¶æ£€æŸ¥:"
            for idx in sh.000001 sh.000300 sz.399001 sz.399006; do
              if [ -f "$idx.parquet" ]; then
                echo "  âœ… $idx.parquet"
              else
                echo "  âŒ $idx.parquet ç¼ºå¤±"
              fi
            done
            echo ""
            
            # æ£€æŸ¥æ•°æ®æœ€æ–°æ—¥æœŸ
            echo "ğŸ” æ£€æŸ¥æ•°æ®æœ€æ–°æ—¥æœŸ..."
            python3 << "PYEOF"
import pandas as pd
from pathlib import Path
import random

try:
    files = list(Path(".").glob("*.parquet"))
    if files:
        # éšæœºæŠ½æ ·æ£€æŸ¥
        samples = random.sample(files, min(5, len(files)))
        latest = None
        
        for f in samples:
            try:
                df = pd.read_parquet(f)
                date_col = "æ—¥æœŸ" if "æ—¥æœŸ" in df.columns else "date"
                if date_col in df.columns:
                    file_latest = pd.to_datetime(df[date_col]).max()
                    if latest is None or file_latest > latest:
                        latest = file_latest
                        latest_file = f.name
            except:
                continue
        
        if latest:
            print(f"âœ… æœ€æ–°æ•°æ®æ—¥æœŸ: {latest.strftime(\"%Y-%m-%d\")}")
            print(f"   ç¤ºä¾‹æ–‡ä»¶: {latest_file}")
        else:
            print("âš ï¸  æ— æ³•è¯»å–æ•°æ®æ—¥æœŸ")
    else:
        print("âŒ ç›®å½•ä¸‹æ²¡æœ‰parquetæ–‡ä»¶")
except Exception as e:
    print(f"âŒ æ£€æŸ¥å¤±è´¥: {e}")
PYEOF
          '
          
          echo ""
          echo "âœ… éªŒè¯å®Œæˆ!"
      
      # æ­¥éª¤8: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          echo "âœ… å·²æ¸…ç†SSHå¯†é’¥"
      
      # æ­¥éª¤9: æˆåŠŸé€šçŸ¥
      - name: ğŸ‰ æ›´æ–°æˆåŠŸ
        if: success()
        run: |
          echo "========================================"
          echo "  âœ… è‚¡ç¥¨æ•°æ®æ›´æ–°æˆåŠŸ! (V3ç‰ˆæœ¬)"
          echo "========================================"
          echo "æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "æ›´æ–°ç­–ç•¥: æ™ºèƒ½å¢é‡æ›´æ–°ï¼ˆå‘å‰æ¨3å¤©ï¼‰"
          echo "æœåŠ¡å™¨: ${{ secrets.SERVER_IP }}"
          echo ""
          echo "æ–‡ä»¶å‘½åè§„èŒƒ:"
          echo "  âœ… è‚¡ç¥¨: çº¯æ•°å­— (å¦‚ 000001.parquet)"
          echo "  âœ… æŒ‡æ•°: å®Œæ•´æ ¼å¼ (å¦‚ sh.000001.parquet)"
          echo "========================================"
      
      # æ­¥éª¤10: å¤±è´¥é€šçŸ¥
      - name: âŒ æ›´æ–°å¤±è´¥
        if: failure()
        run: |
          echo "========================================"
          echo "  âŒ è‚¡ç¥¨æ•°æ®æ›´æ–°å¤±è´¥!"
          echo "========================================"
          echo "å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "è¯·æ£€æŸ¥æ—¥å¿—æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "========================================"
