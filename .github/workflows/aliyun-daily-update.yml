name: Daily-Aliyun-StockData-V3.3-Fixed

on:
  schedule:
    - cron: '30 8 * * 1-5'  # 北京时间16:30（UTC+8）
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout代码
        uses: actions/checkout@v3
      
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          pip install baostock pandas pyarrow tqdm
      
      - name: 配置SSH密钥和rsync
        run: |
          # 安装 rsync
          sudo apt-get update
          sudo apt-get install -y rsync
          
          # 配置 SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          
          # 验证 rsync 安装
          which rsync
          rsync --version
      
      - name: 测试SSH连接
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "echo '✅ SSH连接成功'; hostname"
      
      - name: 智能更新原始数据
        run: |
          echo "=========================================="
          echo "  开始智能更新原始数据"
          echo "=========================================="
          python scripts/download_data_smart.py
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PATH: /root/lightstock
      
      - name: 处理复权数据
        run: |
          echo "=========================================="
          echo "  开始处理复权数据"
          echo "=========================================="
          python scripts/download_processeddata.py
      
      - name: 清洗复权数据
        run: |
          echo "=========================================="
          echo "  开始清洗复权数据"
          echo "=========================================="
          python scripts/clean_adjusted_for_workflow.py
      
      - name: 上传原始数据到阿里云
        run: |
          echo "=========================================="
          echo "  上传原始数据 (daily_parquet)"
          echo "=========================================="
          
          if [ ! -d "data/daily_parquet" ]; then
            echo "❌ daily_parquet 目录不存在"
            exit 1
          fi
          
          FILE_COUNT=$(find data/daily_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "⚠️ 没有需要上传的原始数据"
          else
            echo "📤 准备上传 $FILE_COUNT 个原始数据文件..."
            
            # 确保服务器目录存在
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} \
              "mkdir -p /root/lightstock/data/daily_parquet"
            
            # 使用 rsync 上传（注意：使用 rsync 不带路径）
            rsync -avz --progress \
              -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
              data/daily_parquet/ \
              root@${{ secrets.SERVER_IP }}:/root/lightstock/data/daily_parquet/
            
            echo "✅ 原始数据上传完成"
          fi
      
      - name: 上传复权数据到阿里云
        run: |
          echo "=========
