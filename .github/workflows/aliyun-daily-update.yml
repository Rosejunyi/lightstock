name: Daily-aliyun-StockData-V3-Complete

on:
  schedule:
    - cron: '30 8 * * 1-5'  # 北京时间16:30（UTC+8）
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout代码
        uses: actions/checkout@v3
      
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          pip install baostock pandas pyarrow tqdm
      
      - name: 配置SSH密钥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: 测试SSH连接
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "echo '✅ SSH连接成功'; hostname"
      
      - name: 智能更新原始数据 (V3.1)
        run: |
          python scripts/download_data_smart.py
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PATH: /root/lightstock
      
      - name: 处理复权数据
        run: |
          echo "=========================================="
          echo "  开始处理复权数据"
          echo "=========================================="
          python scripts/download_processeddata.py
      
      - name: 上传原始数据到阿里云
        run: |
          echo "=========================================="
          echo "  上传原始数据 (daily_parquet)"
          echo "=========================================="
          
          # 统计文件数
          FILE_COUNT=$(find data/daily_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "ℹ️  没有需要上传的原始数据"
          else
            echo "📤 准备上传 $FILE_COUNT 个原始数据文件..."
            
            # 确保服务器目录存在
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} \
              "mkdir -p /root/lightstock/data/daily_parquet"
            
            # 使用rsync上传，跳过相同文件
            rsync -avz --progress \
              -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
              data/daily_parquet/ \
              root@${{ secrets.SERVER_IP }}:/root/lightstock/data/daily_parquet/
            
            echo "✅ 原始数据上传完成"
          fi
      
      - name: 上传复权数据到阿里云
        run: |
          echo "=========================================="
          echo "  上传复权数据 (adjusted_parquet)"
          echo "=========================================="
          
          # 统计文件数
          FILE_COUNT=$(find data/adjusted_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "⚠️  没有复权数据文件"
          else
            echo "📤 准备上传 $FILE_COUNT 个复权数据文件..."
            
            # 确保服务器目录存在
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} \
              "mkdir -p /root/lightstock/data/adjusted_parquet"
            
            # 使用rsync上传，跳过相同文件
            rsync -avz --progress \
              -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
              data/adjusted_parquet/ \
              root@${{ secrets.SERVER_IP }}:/root/lightstock/data/adjusted_parquet/
            
            echo "✅ 复权数据上传完成"
          fi
      
      - name: 验证数据完整性
        run: |
          echo "=========================================="
          echo "  验证阿里云服务器数据"
          echo "=========================================="
          
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            cd /root/lightstock/data
            
            echo "📊 原始数据 (daily_parquet):"
            if [ -d "daily_parquet" ]; then
              DAILY_COUNT=$(find daily_parquet -name "*.parquet" | wc -l)
              echo "  文件数: $DAILY_COUNT"
              
              # 显示指数文件
              echo "  指数文件:"
              for idx in sh.000001 sh.000300 sz.399001 sz.399006; do
                if [ -f "daily_parquet/${idx}.parquet" ]; then
                  echo "    ✅ ${idx}.parquet"
                else
                  echo "    ❌ ${idx}.parquet 缺失"
                fi
              done
            else
              echo "  ❌ 目录不存在"
            fi
            
            echo ""
            echo "📈 复权数据 (adjusted_parquet):"
            if [ -d "adjusted_parquet" ]; then
              ADJUSTED_COUNT=$(find adjusted_parquet -name "*.parquet" | wc -l)
              echo "  文件数: $ADJUSTED_COUNT"
              
              # 显示指数文件
              echo "  指数文件:"
              for idx in sh.000001 sh.000300 sz.399001 sz.399006; do
                if [ -f "adjusted_parquet/${idx}.parquet" ]; then
                  echo "    ✅ ${idx}.parquet"
                else
                  echo "    ❌ ${idx}.parquet 缺失"
                fi
              done
            else
              echo "  ❌ 目录不存在"
            fi
            
            echo ""
            echo "✅ 验证完成!"
