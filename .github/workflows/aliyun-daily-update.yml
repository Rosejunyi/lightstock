name: "æ¯æ—¥è‡ªåŠ¨æ›´æ–°é˜¿é‡Œäº‘è½»é‡æœåŠ¡å™¨è‚¡ç¥¨æ•°æ®parquetæ–‡ä»¶"

# è§¦å‘æ–¹å¼
on:
  # 1. å®šæ—¶è‡ªåŠ¨è¿è¡Œ (æ¯ä¸ªäº¤æ˜“æ—¥æ”¶ç›˜å)
  schedule:
    # åŒ—äº¬æ—¶é—´ å‘¨ä¸€åˆ°å‘¨äº” 16:30 (UTC 08:30)
    - cron: '30 8 * * 1-5'
  
  # 2. æ‰‹åŠ¨ä¸€é”®è§¦å‘ (æ— éœ€å¡«å†™æ—¥æœŸ)
  workflow_dispatch:

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.10'
  SERVER_PATH: '/root/lightstock'

jobs:
  update-stock-data:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # æ­¥éª¤2: è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # æ­¥éª¤3: å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install baostock pandas pyarrow tqdm
      
      # æ­¥éª¤4: è‡ªåŠ¨ä¸‹è½½æœ€æ–°æ•°æ® (å‘å‰æ¨3å¤©)
      - name: ğŸ“Š ä¸‹è½½æœ€æ–°æ•°æ®
        run: |
          echo "========================================"
          echo "  å¼€å§‹è‡ªåŠ¨æ›´æ–°è‚¡ç¥¨æ•°æ®"
          echo "========================================"
          echo ""
          echo "ç­–ç•¥: è‡ªåŠ¨è·å–æœ€è¿‘3ä¸ªäº¤æ˜“æ—¥æ•°æ®"
          echo "è¯´æ˜: è¦†ç›–æœ€è¿‘3å¤©,ç¡®ä¿æ•°æ®å®Œæ•´æ€§"
          echo ""
          
          # è¿è¡Œæ›´æ–°è„šæœ¬
          python scripts/download_data_smart.py
          
          echo ""
          echo "âœ… æ•°æ®ä¸‹è½½å®Œæˆ!"
      
      # æ­¥éª¤5: é…ç½®SSH
      - name: ğŸ”‘ é…ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      # æ­¥éª¤6: ä¸Šä¼ åˆ°é˜¿é‡Œäº‘
      - name: ğŸ“¤ ä¸Šä¼ åˆ°é˜¿é‡Œäº‘
        run: |
          echo "========================================"
          echo "  ä¸Šä¼ æ•°æ®åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨"
          echo "========================================"
          echo "æœåŠ¡å™¨: ${{ secrets.SERVER_IP }}"
          echo "è·¯å¾„: ${{ env.SERVER_PATH }}/data/daily_parquet/"
          echo ""
          
          # ä¸Šä¼ æ‰€æœ‰parquetæ–‡ä»¶
          scp -i ~/.ssh/id_rsa -r \
            data/daily_parquet/*.parquet \
            root@${{ secrets.SERVER_IP }}:${{ env.SERVER_PATH }}/data/daily_parquet/
          
          echo ""
          echo "âœ… ä¸Šä¼ å®Œæˆ!"
      
      # æ­¥éª¤7: éªŒè¯æ•°æ®
      - name: âœ… éªŒè¯æœåŠ¡å™¨æ•°æ®
        run: |
          echo "========================================"
          echo "  éªŒè¯æœåŠ¡å™¨ç«¯æ•°æ®"
          echo "========================================"
          echo ""
          
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} << 'SSHEOF'
            cd ${{ env.SERVER_PATH }}/data/daily_parquet/
            
            echo "ğŸ“Š æ•°æ®ç»Ÿè®¡:"
            echo "  æ–‡ä»¶æ€»æ•°: $(ls -1 *.parquet 2>/dev/null | wc -l)"
            echo "  æ€»å¤§å°: $(du -sh . | cut -f1)"
            echo ""
            
            echo "ğŸ“… æœ€æ–°æ›´æ–°çš„5ä¸ªæ–‡ä»¶:"
            ls -lt *.parquet | head -6
            echo ""
            
            echo "ğŸ” éšæœºéªŒè¯ä¸€ä¸ªæ–‡ä»¶:"
            python3 << 'PYEOF'
import pandas as pd
from pathlib import Path

files = list(Path('.').glob('*.parquet'))
if files:
    df = pd.read_parquet(files[0])
    print(f"  æ–‡ä»¶: {files[0].name}")
    print(f"  è®°å½•æ•°: {len(df)}")
    print(f"  æœ€æ–°æ—¥æœŸ: {df['date'].max()}")
else:
    print("  âš ï¸  æœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶")
PYEOF
          SSHEOF
          
          echo ""
          echo "âœ… éªŒè¯å®Œæˆ!"
      
      # æ­¥éª¤8: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          echo "âœ… å·²æ¸…ç†SSHå¯†é’¥"
      
      # æ­¥éª¤9: æˆåŠŸé€šçŸ¥
      - name: ğŸ‰ æ›´æ–°æˆåŠŸ
        if: success()
        run: |
          echo "========================================"
          echo "  âœ… è‚¡ç¥¨æ•°æ®æ›´æ–°æˆåŠŸ!"
          echo "========================================"
          echo "æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "æ›´æ–°ç­–ç•¥: æœ€è¿‘3ä¸ªäº¤æ˜“æ—¥"
          echo "æœåŠ¡å™¨: ${{ secrets.SERVER_IP }}"
          echo "========================================"
      
      # æ­¥éª¤10: å¤±è´¥é€šçŸ¥
      - name: âŒ æ›´æ–°å¤±è´¥
        if: failure()
        run: |
          echo "========================================"
          echo "  âŒ è‚¡ç¥¨æ•°æ®æ›´æ–°å¤±è´¥!"
          echo "========================================"
          echo "å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "è¯·æ£€æŸ¥æ—¥å¿—æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "========================================"
