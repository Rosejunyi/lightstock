name: Daily-Aliyun-StockData-V3.3-Final

on:
  schedule:
    - cron: '30 8 * * 1-5'  # åŒ—äº¬æ—¶é—´16:30ï¼ˆUTC+8ï¼‰
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install baostock pandas pyarrow tqdm
      
      - name: é…ç½®SSHå’Œrsync
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: æµ‹è¯•SSHè¿æ¥
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "echo 'âœ… SSHè¿æ¥æˆåŠŸ'"
      
      - name: æ™ºèƒ½æ›´æ–°åŸå§‹æ•°æ®
        run: |
          echo "=========================================="
          echo "  å¼€å§‹æ™ºèƒ½æ›´æ–°åŸå§‹æ•°æ®"
          echo "=========================================="
          python scripts/download_data_smart.py
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PATH: /root/lightstock
      
      - name: å¤„ç†å¤æƒæ•°æ®
        run: |
          echo "=========================================="
          echo "  å¼€å§‹å¤„ç†å¤æƒæ•°æ®"
          echo "=========================================="
          python scripts/download_processeddata.py
      
      - name: æ¸…æ´—å¤æƒæ•°æ®
        run: |
          echo "=========================================="
          echo "  å¼€å§‹æ¸…æ´—å¤æƒæ•°æ®"
          echo "=========================================="
          python scripts/clean_adjusted_for_workflow.py
      
      - name: ä¸Šä¼ åŸå§‹æ•°æ®åˆ°é˜¿é‡Œäº‘
        run: |
          echo "=========================================="
          echo "  ä¸Šä¼ åŸå§‹æ•°æ® (daily_parquet)"
          echo "=========================================="
          
          if [ ! -d "data/daily_parquet" ]; then
            echo "âŒ daily_parquet ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          FILE_COUNT=$(find data/daily_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âš ï¸ æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„åŸå§‹æ•°æ®"
          else
            echo "ğŸ“¤ å‡†å¤‡ä¸Šä¼  $FILE_COUNT ä¸ªåŸå§‹æ•°æ®æ–‡ä»¶..."
            
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data/daily_parquet"
            
            rsync -avz --progress -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" data/daily_parquet/ root@${{ secrets.SERVER_IP }}:/root/lightstock/data/daily_parquet/
            
            echo "âœ… åŸå§‹æ•°æ®ä¸Šä¼ å®Œæˆ"
          fi
      
      - name: ä¸Šä¼ å¤æƒæ•°æ®åˆ°é˜¿é‡Œäº‘
        run: |
          echo "=========================================="
          echo "  ä¸Šä¼ å¤æƒæ•°æ® (adjusted_parquet)"
          echo "=========================================="
          
          if [ ! -d "data/adjusted_parquet" ]; then
            echo "âš ï¸ adjusted_parquet ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            exit 0
          fi
          
          FILE_COUNT=$(find data/adjusted_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âš ï¸ æ²¡æœ‰å¤æƒæ•°æ®æ–‡ä»¶"
          else
            echo "ğŸ“¤ å‡†å¤‡ä¸Šä¼  $FILE_COUNT ä¸ªå¤æƒæ•°æ®æ–‡ä»¶..."
            
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data/adjusted_parquet"
            
            rsync -avz --progress -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" data/adjusted_parquet/ root@${{ secrets.SERVER_IP }}:/root/lightstock/data/adjusted_parquet/
            
            echo "âœ… å¤æƒæ•°æ®ä¸Šä¼ å®Œæˆ"
          fi
      
      - name: ä¸Šä¼ æ¸…æ´—æ•°æ®åˆ°é˜¿é‡Œäº‘
        run: |
          echo "=========================================="
          echo "  ä¸Šä¼ æ¸…æ´—æ•°æ® (cleaned_parquet)"
          echo "=========================================="
          
          if [ ! -d "data/cleaned_parquet" ]; then
            echo "âš ï¸ cleaned_parquet ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            exit 0
          fi
          
          FILE_COUNT=$(find data/cleaned_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âš ï¸ æ²¡æœ‰æ¸…æ´—æ•°æ®"
          else
            echo "ğŸ“¤ å‡†å¤‡ä¸Šä¼  $FILE_COUNT ä¸ªæ¸…æ´—æ–‡ä»¶..."
            
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data/cleaned_parquet"
            
            rsync -avz --progress -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" data/cleaned_parquet/ root@${{ secrets.SERVER_IP }}:/root/lightstock/data/cleaned_parquet/
            
            echo "âœ… æ¸…æ´—æ•°æ®ä¸Šä¼ å®Œæˆ"
          fi
      
      - name: éªŒè¯æ•°æ®å®Œæ•´æ€§
        run: |
          echo "=========================================="
          echo "  éªŒè¯é˜¿é‡Œäº‘æœåŠ¡å™¨æ•°æ®"
          echo "=========================================="
          
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} 'bash -s' << 'ENDSSH'
            cd /root/lightstock/data
            
            echo "ğŸ“Š åŸå§‹æ•°æ®:"
            if [ -d "daily_parquet" ]; then
              COUNT=$(find daily_parquet -name "*.parquet" 2>/dev/null | wc -l)
              echo "  æ–‡ä»¶æ•°: $COUNT"
            else
              echo "  âŒ ç›®å½•ä¸å­˜åœ¨"
            fi
            
            echo ""
            echo "ğŸ“ˆ å¤æƒæ•°æ®:"
            if [ -d "adjusted_parquet" ]; then
              COUNT=$(find adjusted_parquet -name "*.parquet" 2>/dev/null | wc -l)
              echo "  æ–‡ä»¶æ•°: $COUNT"
            else
              echo "  âŒ ç›®å½•ä¸å­˜åœ¨"
            fi
            
            echo ""
            echo "ğŸ§¹ æ¸…æ´—æ•°æ®:"
            if [ -d "cleaned_parquet" ]; then
              COUNT=$(find cleaned_parquet -name "*.parquet" 2>/dev/null | wc -l)
              echo "  æ–‡ä»¶æ•°: $COUNT"
            else
              echo "  âŒ ç›®å½•ä¸å­˜åœ¨"
            fi
            
            echo ""
            echo "âœ… éªŒè¯å®Œæˆ!"
          ENDSSH
