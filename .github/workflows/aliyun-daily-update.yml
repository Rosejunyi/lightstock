name: Daily-Aliyun-StockData-V3.3-Fixed

on:
  schedule:
    - cron: '30 8 * * 1-5'  # åŒ—äº¬æ—¶é—´16:30ï¼ˆUTC+8ï¼‰
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install baostock pandas pyarrow tqdm
      
      - name: é…ç½®SSHå¯†é’¥å’Œrsync
        run: |
          # å®‰è£… rsync
          sudo apt-get update
          sudo apt-get install -y rsync
          
          # é…ç½® SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          
          # éªŒè¯ rsync å®‰è£…
          which rsync
          rsync --version
      
      - name: æµ‹è¯•SSHè¿æ¥
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "echo 'âœ… SSHè¿æ¥æˆåŠŸ'; hostname"
      
      - name: æ™ºèƒ½æ›´æ–°åŸå§‹æ•°æ®
        run: |
          echo "=========================================="
          echo "  å¼€å§‹æ™ºèƒ½æ›´æ–°åŸå§‹æ•°æ®"
          echo "=========================================="
          python scripts/download_data_smart.py
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PATH: /root/lightstock
      
      - name: å¤„ç†å¤æƒæ•°æ®
        run: |
          echo "=========================================="
          echo "  å¼€å§‹å¤„ç†å¤æƒæ•°æ®"
          echo "=========================================="
          python scripts/download_processeddata.py
      
      - name: æ¸…æ´—å¤æƒæ•°æ®
        run: |
          echo "=========================================="
          echo "  å¼€å§‹æ¸…æ´—å¤æƒæ•°æ®"
          echo "=========================================="
          python scripts/clean_adjusted_for_workflow.py
      
      - name: ä¸Šä¼ åŸå§‹æ•°æ®åˆ°é˜¿é‡Œäº‘
        run: |
          echo "=========================================="
          echo "  ä¸Šä¼ åŸå§‹æ•°æ® (daily_parquet)"
          echo "=========================================="
          
          if [ ! -d "data/daily_parquet" ]; then
            echo "âŒ daily_parquet ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          FILE_COUNT=$(find data/daily_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âš ï¸ æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„åŸå§‹æ•°æ®"
          else
            echo "ğŸ“¤ å‡†å¤‡ä¸Šä¼  $FILE_COUNT ä¸ªåŸå§‹æ•°æ®æ–‡ä»¶..."
            
            # ç¡®ä¿æœåŠ¡å™¨ç›®å½•å­˜åœ¨
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} \
              "mkdir -p /root/lightstock/data/daily_parquet"
            
            # ä½¿ç”¨ rsync ä¸Šä¼ ï¼ˆæ³¨æ„ï¼šä½¿ç”¨ rsync ä¸å¸¦è·¯å¾„ï¼‰
            rsync -avz --progress \
              -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
              data/daily_parquet/ \
              root@${{ secrets.SERVER_IP }}:/root/lightstock/data/daily_parquet/
            
            echo "âœ… åŸå§‹æ•°æ®ä¸Šä¼ å®Œæˆ"
          fi
      
      - name: ä¸Šä¼ å¤æƒæ•°æ®åˆ°é˜¿é‡Œäº‘
        run: |
          echo "=========
