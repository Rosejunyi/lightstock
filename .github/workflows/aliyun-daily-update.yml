name: Daily-Aliyun-StockData-V3.3

on:
  schedule:
    - cron: '30 8 * * 1-5'  # åŒ—äº¬æ—¶é—´16:30ï¼ˆUTC+8ï¼‰
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install baostock pandas pyarrow tqdm
      
      - name: é…ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: æµ‹è¯•SSHè¿æ¥
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "echo 'âœ… SSHè¿æ¥æˆåŠŸ'; hostname"
      
      - name: æ™ºèƒ½æ›´æ–°åŸå§‹æ•°æ® (V3.3 ç²¾ç®€ç‰ˆ)
        run: |
          echo "=========================================="
          echo "  å¼€å§‹æ™ºèƒ½æ›´æ–°åŸå§‹æ•°æ®"
          echo "=========================================="
          python scripts/download_data_smart.py
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PATH: /root/lightstock
      
      - name: å¤„ç†å¤æƒæ•°æ®
        run: |
          echo "=========================================="
          echo "  å¼€å§‹å¤„ç†å¤æƒæ•°æ®"
          echo "=========================================="
          python scripts/download_processeddata.py
      
      - name: æ¸…æ´—å¤æƒæ•°æ® â­
        run: |
          echo "=========================================="
          echo "  å¼€å§‹æ¸…æ´—å¤æƒæ•°æ®"
          echo "=========================================="
          python scripts/clean_adjusted_for_workflow.py
      
      - name: ä¸Šä¼ åŸå§‹æ•°æ®åˆ°é˜¿é‡Œäº‘
        run: |
          echo "=========================================="
          echo "  ä¸Šä¼ åŸå§‹æ•°æ® (daily_parquet)"
          echo "=========================================="
          
          FILE_COUNT=$(find data/daily_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "â„¹ï¸  æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„åŸå§‹æ•°æ®"
          else
            echo "ğŸ“¤ å‡†å¤‡ä¸Šä¼  $FILE_COUNT ä¸ªåŸå§‹æ•°æ®æ–‡ä»¶..."
            
            ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} \
              "mkdir -p /root/lightstock/data/daily_parquet"
            
            rsync -avz --progress \
              -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
              data/daily_parquet/ \
              root@${{ secrets.SERVER_IP }}:/root/lightstock/data/daily_parquet/
            
            echo "âœ… åŸå§‹æ•°æ®ä¸Šä¼ å®Œæˆ"
          fi
      
      - name: ä¸Šä¼ å¤æƒæ•°æ®åˆ°é˜¿é‡Œäº‘
        run: |
          echo "=========================================="
          echo "  ä¸Šä¼ å¤æƒæ•°æ® (adjusted_parquet)"
          echo "=========================================="
          
          FILE_COUNT=$(find data/adjusted_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âš ï¸  æ²¡æœ‰å¤æƒæ•°æ®æ–‡ä»¶"
          else
            echo "ğŸ“¤ å‡†å¤‡ä¸Šä¼  $FILE_COUNT ä¸ªå¤æƒæ•°æ®æ–‡ä»¶..."
            
            ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} \
              "mkdir -p /root/lightstock/data/adjusted_parquet"
            
            rsync -avz --progress \
              -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
              data/adjusted_parquet/ \
              root@${{ secrets.SERVER_IP }}:/root/lightstock/data/adjusted_parquet/
            
            echo "âœ… å¤æƒæ•°æ®ä¸Šä¼ å®Œæˆ"
          fi
      
      - name: ä¸Šä¼ æ¸…æ´—æ•°æ®åˆ°é˜¿é‡Œäº‘ â­
        run: |
          echo "=========================================="
          echo "  ä¸Šä¼ æ¸…æ´—æ•°æ® (cleaned_parquet)"
          echo "=========================================="
          
          FILE_COUNT=$(find data/cleaned_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âš ï¸  æ²¡æœ‰æ¸…æ´—æ•°æ®"
          else
            echo "ğŸ“¤ å‡†å¤‡ä¸Šä¼  $FILE_COUNT ä¸ªæ¸…æ´—æ–‡ä»¶..."
            
            ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} \
              "mkdir -p /root/lightstock/data/cleaned_parquet"
            
            rsync -avz --progress \
              -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
              data/cleaned_parquet/ \
              root@${{ secrets.SERVER_IP }}:/root/lightstock/data/cleaned_parquet/
            
            echo "âœ… æ¸…æ´—æ•°æ®ä¸Šä¼ å®Œæˆ"
          fi
      
      - name: éªŒè¯æ•°æ®å®Œæ•´æ€§
        run: |
          echo "=========================================="
          echo "  éªŒè¯é˜¿é‡Œäº‘æœåŠ¡å™¨æ•°æ®"
          echo "=========================================="
          
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} << 'EOF'
            cd /root/lightstock/data
            
            echo "ğŸ“Š åŸå§‹æ•°æ® (daily_parquet):"
            if [ -d "daily_parquet" ]; then
              DAILY_COUNT=$(find daily_parquet -name "*.parquet" | wc -l)
              echo "  æ–‡ä»¶æ•°: $DAILY_COUNT"
            else
              echo "  âŒ ç›®å½•ä¸å­˜åœ¨"
            fi
            
            echo ""
            echo "ğŸ“ˆ å¤æƒæ•°æ® (adjusted_parquet):"
            if [ -d "adjusted_parquet" ]; then
              ADJUSTED_COUNT=$(find adjusted_parquet -name "*.parquet" | wc -l)
              echo "  æ–‡ä»¶æ•°: $ADJUSTED_COUNT"
            else
              echo "  âŒ ç›®å½•ä¸å­˜åœ¨"
            fi
            
            echo ""
            echo "ğŸ§¹ æ¸…æ´—æ•°æ® (cleaned_parquet):"
            if [ -d "cleaned_parquet" ]; then
              CLEANED_COUNT=$(find cleaned_parquet -name "*.parquet" | wc -l)
              echo "  æ–‡ä»¶æ•°: $CLEANED_COUNT"
              
              # æ˜¾ç¤ºæœ€æ–°æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´
              LATEST_FILE=$(ls -t cleaned_parquet/*.parquet 2>/dev/null | head -1)
              if [ -n "$LATEST_FILE" ]; then
                echo "  æœ€æ–°æ–‡ä»¶: $(basename $LATEST_FILE)"
                echo "  ä¿®æ”¹æ—¶é—´: $(stat -c %y "$LATEST_FILE" 2>/dev/null | cut -d'.' -f1)"
              fi
            else
              echo "  âŒ ç›®å½•ä¸å­˜åœ¨"
            fi
            
            echo ""
            echo "âœ… éªŒè¯å®Œæˆ!"
EOF
