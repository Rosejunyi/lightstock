name: Daily-aliyun-StockData-V3-Complete

on:
  schedule:
    - cron: '30 8 * * 1-5'  # åŒ—äº¬æ—¶é—´16:30ï¼ˆUTC+8ï¼‰
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install baostock pandas pyarrow tqdm
      
      - name: é…ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: æµ‹è¯•SSHè¿æ¥
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "echo 'âœ… SSHè¿æ¥æˆåŠŸ'; hostname"
      
      - name: æ™ºèƒ½æ›´æ–°åŸå§‹æ•°æ® (V3.1)
        run: |
          python scripts/download_data_smart.py
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PATH: /root/lightstock
      
      - name: å¤„ç†å¤æƒæ•°æ®
        run: |
          echo "=========================================="
          echo "  å¼€å§‹å¤„ç†å¤æƒæ•°æ®"
          echo "=========================================="
          python scripts/download_processeddata.py
      
      - name: ä¸Šä¼ åŸå§‹æ•°æ®åˆ°é˜¿é‡Œäº‘
        run: |
          echo "=========================================="
          echo "  ä¸Šä¼ åŸå§‹æ•°æ® (daily_parquet)"
          echo "=========================================="
          
          # ç»Ÿè®¡æ–‡ä»¶æ•°
          FILE_COUNT=$(find data/daily_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "â„¹ï¸  æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„åŸå§‹æ•°æ®"
          else
            echo "ğŸ“¤ å‡†å¤‡ä¸Šä¼  $FILE_COUNT ä¸ªåŸå§‹æ•°æ®æ–‡ä»¶..."
            
            # ç¡®ä¿æœåŠ¡å™¨ç›®å½•å­˜åœ¨
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} \
              "mkdir -p /root/lightstock/data/daily_parquet"
            
            # ä½¿ç”¨rsyncä¸Šä¼ ï¼Œè·³è¿‡ç›¸åŒæ–‡ä»¶
            rsync -avz --progress \
              -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
              data/daily_parquet/ \
              root@${{ secrets.SERVER_IP }}:/root/lightstock/data/daily_parquet/
            
            echo "âœ… åŸå§‹æ•°æ®ä¸Šä¼ å®Œæˆ"
          fi
      
      - name: ä¸Šä¼ å¤æƒæ•°æ®åˆ°é˜¿é‡Œäº‘
        run: |
          echo "=========================================="
          echo "  ä¸Šä¼ å¤æƒæ•°æ® (adjusted_parquet)"
          echo "=========================================="
          
          # ç»Ÿè®¡æ–‡ä»¶æ•°
          FILE_COUNT=$(find data/adjusted_parquet -name "*.parquet" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âš ï¸  æ²¡æœ‰å¤æƒæ•°æ®æ–‡ä»¶"
          else
            echo "ğŸ“¤ å‡†å¤‡ä¸Šä¼  $FILE_COUNT ä¸ªå¤æƒæ•°æ®æ–‡ä»¶..."
            
            # ç¡®ä¿æœåŠ¡å™¨ç›®å½•å­˜åœ¨
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} \
              "mkdir -p /root/lightstock/data/adjusted_parquet"
            
            # ä½¿ç”¨rsyncä¸Šä¼ ï¼Œè·³è¿‡ç›¸åŒæ–‡ä»¶
            rsync -avz --progress \
              -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
              data/adjusted_parquet/ \
              root@${{ secrets.SERVER_IP }}:/root/lightstock/data/adjusted_parquet/
            
            echo "âœ… å¤æƒæ•°æ®ä¸Šä¼ å®Œæˆ"
          fi
      
      - name: éªŒè¯æ•°æ®å®Œæ•´æ€§
        run: |
          echo "=========================================="
          echo "  éªŒè¯é˜¿é‡Œäº‘æœåŠ¡å™¨æ•°æ®"
          echo "=========================================="
          
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            cd /root/lightstock/data
            
            echo "ğŸ“Š åŸå§‹æ•°æ® (daily_parquet):"
            if [ -d "daily_parquet" ]; then
              DAILY_COUNT=$(find daily_parquet -name "*.parquet" | wc -l)
              echo "  æ–‡ä»¶æ•°: $DAILY_COUNT"
              
              # æ˜¾ç¤ºæŒ‡æ•°æ–‡ä»¶
              echo "  æŒ‡æ•°æ–‡ä»¶:"
              for idx in sh.000001 sh.000300 sz.399001 sz.399006; do
                if [ -f "daily_parquet/${idx}.parquet" ]; then
                  echo "    âœ… ${idx}.parquet"
                else
                  echo "    âŒ ${idx}.parquet ç¼ºå¤±"
                fi
              done
            else
              echo "  âŒ ç›®å½•ä¸å­˜åœ¨"
            fi
            
            echo ""
            echo "ğŸ“ˆ å¤æƒæ•°æ® (adjusted_parquet):"
            if [ -d "adjusted_parquet" ]; then
              ADJUSTED_COUNT=$(find adjusted_parquet -name "*.parquet" | wc -l)
              echo "  æ–‡ä»¶æ•°: $ADJUSTED_COUNT"
              
              # æ˜¾ç¤ºæŒ‡æ•°æ–‡ä»¶
              echo "  æŒ‡æ•°æ–‡ä»¶:"
              for idx in sh.000001 sh.000300 sz.399001 sz.399006; do
                if [ -f "adjusted_parquet/${idx}.parquet" ]; then
                  echo "    âœ… ${idx}.parquet"
                else
                  echo "    âŒ ${idx}.parquet ç¼ºå¤±"
                fi
              done
            else
              echo "  âŒ ç›®å½•ä¸å­˜åœ¨"
            fi
            
            echo ""
            echo "âœ… éªŒè¯å®Œæˆ!"
