name: Daily-Stock-Data-Pipeline-SMART-SKIP

on:
  schedule:
    - cron: '30 8 * * 1-5'
  workflow_dispatch:

jobs:
  stock-data-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install baostock pandas pyarrow tqdm numpy ta-lib scikit-learn

      - name: é…ç½® SSH å’Œ rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # ========================================
      # âœ¨ æ™ºèƒ½æ£€æŸ¥ï¼šåˆ¤æ–­ä»Šå¤©æ˜¯å¦éœ€è¦æ›´æ–°æ•°æ®
      # ========================================
      - name: æ™ºèƒ½æ£€æŸ¥ - åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
        id: smart_check
        run: |
          python3 << 'PYTHON_SCRIPT'
          from datetime import datetime
          import sys
          
          # è·å–ä»Šå¤©æ˜¯æ˜ŸæœŸå‡ ï¼ˆ0=å‘¨ä¸€, 6=å‘¨æ—¥ï¼‰
          today = datetime.now()
          weekday = today.weekday()
          
          print(f"ğŸ“… ä»Šå¤©: {today.strftime('%Y-%m-%d')} ({['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'][weekday]})")
          
          # åˆ¤æ–­æ˜¯å¦æ˜¯äº¤æ˜“æ—¥
          if weekday >= 5:  # å‘¨å…­æˆ–å‘¨æ—¥
              print("â­ï¸  ä»Šå¤©æ˜¯å‘¨æœ«ï¼ˆéäº¤æ˜“æ—¥ï¼‰ï¼Œæ•°æ®åº”è¯¥å·²æ˜¯ä¸Šå‘¨äº”çš„")
              print("è·³è¿‡æ‰€æœ‰ä¸‹è½½æ­¥éª¤ï¼Œé¿å…é‡å¤ä¸‹è½½")
              print("skip_download=true")
              # è®¾ç½®ç¯å¢ƒå˜é‡
              with open('$GITHUB_ENV', 'a') as f:
                  f.write('SKIP_DOWNLOAD=true\n')
          else:
              print("âœ… ä»Šå¤©æ˜¯å·¥ä½œæ—¥ï¼Œå¯èƒ½éœ€è¦æ›´æ–°æ•°æ®")
              print("skip_download=false")
              with open('$GITHUB_ENV', 'a') as f:
                  f.write('SKIP_DOWNLOAD=false\n')
          PYTHON_SCRIPT

      - name: æ˜¾ç¤ºè·³è¿‡çŠ¶æ€
        run: |
          echo "=========================================="
          echo "æ™ºèƒ½è·³è¿‡æ£€æŸ¥ç»“æœ"
          echo "=========================================="
          echo "SKIP_DOWNLOAD = ${{ env.SKIP_DOWNLOAD }}"
          
          if [ "${{ env.SKIP_DOWNLOAD }}" = "true" ]; then
            echo ""
            echo "â­ï¸  ä»Šå¤©æ˜¯å‘¨æœ«ï¼Œæ•°æ®å·²æ˜¯æœ€æ–°"
            echo "å°†è·³è¿‡æ‰€æœ‰ä¸‹è½½æ­¥éª¤"
            echo ""
            echo "ğŸ’¡ æç¤ºï¼š"
            echo "  - å¦‚æœéœ€è¦å¼ºåˆ¶æ›´æ–°ï¼Œè¯·æ‰‹åŠ¨è§¦å‘workflowå¹¶ä¿®æ”¹æ£€æŸ¥é€»è¾‘"
            echo "  - æˆ–è€…åœ¨å·¥ä½œæ—¥è¿è¡Œæ­¤workflow"
          else
            echo ""
            echo "âœ… å¼€å§‹æ‰§è¡Œæ•°æ®æ›´æ–°"
          fi
          echo "=========================================="

      # åˆ›å»ºä¸Šä¼ è„šæœ¬
      - name: åˆ›å»ºä¸Šä¼ è„šæœ¬
        if: env.SKIP_DOWNLOAD != 'true'
        run: |
          cat > upload_data.sh << 'EOF'
          #!/bin/bash
          DIR_NAME=$1
          REMOTE_PATH=$2
          
          if [ -d "$DIR_NAME" ] || [ -f "$DIR_NAME" ]; then
            echo "ğŸ“¤ ä¸Šä¼  $DIR_NAME..."
            rsync -avz --progress -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
              "$DIR_NAME" \
              root@${{ secrets.SERVER_IP }}:"$REMOTE_PATH"
            echo "âœ… $DIR_NAME ä¸Šä¼ å®Œæˆ"
          else
            echo "âš ï¸  $DIR_NAME ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¸Šä¼ "
          fi
          EOF
          chmod +x upload_data.sh

      # ========================================
      # S1: ä¸‹è½½ä¸ªè‚¡ K çº¿æ•°æ®
      # ========================================
      - name: S1 - ä¸‹è½½ä¸ªè‚¡Kçº¿æ•°æ®ï¼ˆå¢é‡ï¼‰
        if: env.SKIP_DOWNLOAD != 'true'
        continue-on-error: true
        id: step_s1
        run: |
          echo "=========================================="
          echo "  S1: ä¸‹è½½ä¸ªè‚¡Kçº¿æ•°æ®ï¼ˆä¸å¤æƒï¼Œå¢é‡ï¼‰"
          echo "=========================================="
          python scripts/S1_20251103_download_kline_ä¸ªè‚¡å¢é‡.py

      - name: S1 - ç«‹å³ä¸Šä¼ æ•°æ®
        if: env.SKIP_DOWNLOAD != 'true' && steps.step_s1.outcome == 'success'
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data/daily_kline_raw"
          ./upload_data.sh "data/daily_kline_raw/" "/root/lightstock/data/daily_kline_raw/"

      # ========================================
      # S2: ä¸‹è½½å¤æƒæ•°æ®
      # ========================================
      - name: S2 - ä¸‹è½½å¤æƒæ•°æ®ï¼ˆå¢é‡ï¼‰
        if: env.SKIP_DOWNLOAD != 'true'
        continue-on-error: true
        id: step_s2
        run: |
          echo "=========================================="
          echo "  S2: ä¸‹è½½å¤æƒæ•°æ®ï¼ˆå‰å¤æƒ+åå¤æƒï¼Œå¢é‡ï¼‰"
          echo "=========================================="
          python scripts/S2_20251103_download_adjusted_å¤æƒå¢é‡.py

      - name: S2 - ç«‹å³ä¸Šä¼ æ•°æ®
        if: env.SKIP_DOWNLOAD != 'true' && steps.step_s2.outcome == 'success'
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data/{daily_parquet_qfq,daily_parquet_hfq}"
          ./upload_data.sh "data/daily_parquet_qfq/" "/root/lightstock/data/daily_parquet_qfq/"
          ./upload_data.sh "data/daily_parquet_hfq/" "/root/lightstock/data/daily_parquet_hfq/"

      # ========================================
      # S3: ä¸‹è½½å¤§ç›˜æŒ‡æ•°æ•°æ®
      # ========================================
      - name: S3 - ä¸‹è½½å¤§ç›˜æŒ‡æ•°æ•°æ®ï¼ˆå¢é‡ï¼‰
        if: env.SKIP_DOWNLOAD != 'true'
        continue-on-error: true
        id: step_s3
        run: |
          echo "=========================================="
          echo "  S3: ä¸‹è½½å¤§ç›˜æŒ‡æ•°æ•°æ®ï¼ˆå¢é‡ï¼‰"
          echo "=========================================="
          python scripts/S3_20251103_download_index_å¤§ç›˜å¢é‡.py

      - name: S3 - ç«‹å³ä¸Šä¼ æ•°æ®
        if: env.SKIP_DOWNLOAD != 'true' && steps.step_s3.outcome == 'success'
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data/index_data"
          ./upload_data.sh "data/index_data/" "/root/lightstock/data/index_data/"

      # ========================================
      # S4: è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
      # ========================================
      - name: S4 - è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼ˆå…¨é‡ï¼‰
        if: env.SKIP_DOWNLOAD != 'true'
        continue-on-error: true
        id: step_s4
        run: |
          echo "=========================================="
          echo "  S4: è®¡ç®—ä¸ªè‚¡åŠå¤§ç›˜æŠ€æœ¯æŒ‡æ ‡ï¼ˆå…¨é‡ï¼‰"
          echo "=========================================="
          python scripts/S4_20251102\ calculate_ä¸ªè‚¡åŠå¤§ç›˜æŠ€æœ¯å…¨é‡è®¡ç®—.py

      - name: S4 - ç«‹å³ä¸Šä¼ æ•°æ®
        if: env.SKIP_DOWNLOAD != 'true' && steps.step_s4.outcome == 'success'
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data/technical_indicators"
          ./upload_data.sh "data/technical_indicators/" "/root/lightstock/data/technical_indicators/"

      # ========================================
      # S5: ç”Ÿæˆæ¯æ—¥æŠ€æœ¯å¿«ç…§
      # ========================================
      - name: S5 - ç”Ÿæˆæ¯æ—¥æŠ€æœ¯å¿«ç…§
        if: env.SKIP_DOWNLOAD != 'true'
        continue-on-error: true
        id: step_s5
        run: |
          echo "=========================================="
          echo "  S5: ç”Ÿæˆä¸ªè‚¡æ¯æ—¥æŠ€æœ¯å¿«ç…§"
          echo "=========================================="
          python scripts/S5_20251103_generate_daily_ä¸ªè‚¡æ¯æ—¥æŠ€æœ¯å¿«ç…§.py

      - name: S5 - ç«‹å³ä¸Šä¼ æ•°æ®
        if: env.SKIP_DOWNLOAD != 'true' && steps.step_s5.outcome == 'success'
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data/daily_snapshot"
          ./upload_data.sh "data/daily_snapshot/" "/root/lightstock/data/daily_snapshot/"

      # ========================================
      # S6: åŸºç¡€å¼ºåŠ¿è‚¡ç­›é€‰
      # ========================================
      - name: S6 - åŸºç¡€å¼ºåŠ¿è‚¡ç­›é€‰
        if: env.SKIP_DOWNLOAD != 'true'
        continue-on-error: true
        id: step_s6
        run: |
          echo "=========================================="
          echo "  S6: åŸºç¡€å¼ºåŠ¿è‚¡ç­›é€‰ï¼ˆCANSLIMï¼‰"
          echo "=========================================="
          python scripts/S6_20251103_\ åŸºç¡€å¼ºåŠ¿è‚¡ç­›é€‰.py

      - name: S6 - ç«‹å³ä¸Šä¼ æ•°æ®
        if: env.SKIP_DOWNLOAD != 'true' && steps.step_s6.outcome == 'success'
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data/canslim_screening"
          ./upload_data.sh "data/canslim_screening/" "/root/lightstock/data/canslim_screening/"

      # ========================================
      # S7: ç”Ÿæˆå¸‚åœºèšåˆæ•°æ®
      # ========================================
      - name: S7 - ç”Ÿæˆå¸‚åœºèšåˆæ•°æ®
        if: env.SKIP_DOWNLOAD != 'true'
        continue-on-error: true
        id: step_s7
        run: |
          echo "=========================================="
          echo "  S7: ç”Ÿæˆå¸‚åœºèšåˆæ•°æ®"
          echo "=========================================="
          python scripts/S7_20251103_generate_marketå¸‚åœºèšåˆæ•°æ®.py

      - name: S7 - ç«‹å³ä¸Šä¼ æ•°æ®
        if: env.SKIP_DOWNLOAD != 'true' && steps.step_s7.outcome == 'success'
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data/market_aggregates"
          ./upload_data.sh "data/market_aggregates/" "/root/lightstock/data/market_aggregates/"

      # ========================================
      # S8: æŠ€æœ¯æŒ‡æ ‡å†·çƒ­åˆ†ç¦»
      # ========================================
      - name: S8 - æŠ€æœ¯æŒ‡æ ‡å†·çƒ­åˆ†ç¦»
        if: env.SKIP_DOWNLOAD != 'true'
        continue-on-error: true
        id: step_s8
        run: |
          echo "=========================================="
          echo "  S8: ä¸ªè‚¡æŠ€æœ¯æ•°æ®å†·çƒ­åˆ†ç¦»"
          echo "=========================================="
          python scripts/S8_20251103_split_hot_cold_ä¸ªè‚¡æŠ€æœ¯å†·çƒ­åˆ†ç¦».py

      - name: S8 - ç«‹å³ä¸Šä¼ æ•°æ®
        if: env.SKIP_DOWNLOAD != 'true' && steps.step_s8.outcome == 'success'
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data/technical_indicators_hot"
          ./upload_data.sh "data/technical_indicators_hot/" "/root/lightstock/data/technical_indicators_hot/"

      # ========================================
      # S9: ä¸‹è½½è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ï¼ˆå‘¨æ›´ï¼‰
      # ========================================
      - name: S9 - ä¸‹è½½è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ï¼ˆå‘¨æ›´ï¼‰
        continue-on-error: true
        id: step_s9
        run: |
          echo "=========================================="
          echo "  S9: ä¸‹è½½è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ï¼ˆå¢é‡ï¼Œå‘¨æ›´ï¼‰"
          echo "=========================================="
          # åªåœ¨å‘¨ä¸€æ‰§è¡Œ
          if [ $(date +%u) -eq 1 ]; then
            python scripts/S9_20251102\ download_å¢é‡è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯_å‘¨æ›´.py
          else
            echo "â­ï¸  ä»Šå¤©ä¸æ˜¯å‘¨ä¸€ï¼Œè·³è¿‡ S9"
          fi

      - name: S9 - ç«‹å³ä¸Šä¼ æ•°æ®
        if: steps.step_s9.outcome == 'success'
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} "mkdir -p /root/lightstock/data"
          ./upload_data.sh "data/stock_basic_info.parquet" "/root/lightstock/data/"

      # ========================================
      # ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
      # ========================================
      - name: ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "=========================================="
          echo "  ğŸ“‹ Pipeline æ‰§è¡ŒæŠ¥å‘Š"
          echo "=========================================="
          echo "æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "æ‰§è¡Œåˆ†æ”¯: ${{ github.ref_name }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo ""
          
          if [ "${{ env.SKIP_DOWNLOAD }}" = "true" ]; then
            echo "â­ï¸  æ‰€æœ‰ä¸‹è½½æ­¥éª¤å·²è·³è¿‡ï¼ˆä»Šå¤©æ˜¯å‘¨æœ«ï¼‰"
            echo ""
            echo "ğŸ’¡ æ•°æ®çŠ¶æ€:"
            echo "  - æ‰€æœ‰æ•°æ®åº”è¯¥å·²æ˜¯ä¸Šå‘¨äº”çš„"
            echo "  - æ— éœ€é‡å¤ä¸‹è½½"
            echo "  - å¦‚éœ€å¼ºåˆ¶æ›´æ–°ï¼Œè¯·åœ¨å·¥ä½œæ—¥æ‰‹åŠ¨è§¦å‘"
          else
            echo "å„æ­¥éª¤æ‰§è¡ŒçŠ¶æ€ï¼š"
            echo "  S1 (ä¸ªè‚¡Kçº¿): ${{ steps.step_s1.outcome }}"
            echo "  S2 (å¤æƒæ•°æ®): ${{ steps.step_s2.outcome }}"
            echo "  S3 (å¤§ç›˜æŒ‡æ•°): ${{ steps.step_s3.outcome }}"
            echo "  S4 (æŠ€æœ¯æŒ‡æ ‡): ${{ steps.step_s4.outcome }}"
            echo "  S5 (æ¯æ—¥å¿«ç…§): ${{ steps.step_s5.outcome }}"
            echo "  S6 (å¼ºåŠ¿è‚¡ç­›é€‰): ${{ steps.step_s6.outcome }}"
            echo "  S7 (å¸‚åœºèšåˆ): ${{ steps.step_s7.outcome }}"
            echo "  S8 (å†·çƒ­åˆ†ç¦»): ${{ steps.step_s8.outcome }}"
            echo "  S9 (è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯): ${{ steps.step_s9.outcome }}"
            
            # ç»Ÿè®¡
            SUCCESS=0
            FAIL=0
            
            for outcome in "${{ steps.step_s1.outcome }}" "${{ steps.step_s2.outcome }}" "${{ steps.step_s3.outcome }}" "${{ steps.step_s4.outcome }}" "${{ steps.step_s5.outcome }}" "${{ steps.step_s6.outcome }}" "${{ steps.step_s7.outcome }}" "${{ steps.step_s8.outcome }}" "${{ steps.step_s9.outcome }}"; do
              if [ "$outcome" = "success" ]; then
                SUCCESS=$((SUCCESS + 1))
              elif [ "$outcome" = "failure" ]; then
                FAIL=$((FAIL + 1))
              fi
            done
            
            echo ""
            echo "âœ… æˆåŠŸ: $SUCCESS ä¸ªæ­¥éª¤"
            echo "âŒ å¤±è´¥: $FAIL ä¸ªæ­¥éª¤"
          fi
          echo "=========================================="
