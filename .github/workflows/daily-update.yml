name: é˜¿é‡Œäº‘daily_parquet æ¯æ—¥æ›´æ–°è‚¡ç¥¨æ•°æ®

# è§¦å‘æ¡ä»¶
on:
  # 1. å®šæ—¶è§¦å‘ (æ¯ä¸ªäº¤æ˜“æ—¥æ”¶ç›˜å)
  schedule:
    # åŒ—äº¬æ—¶é—´ å‘¨ä¸€åˆ°å‘¨äº” 16:30 (UTC+8 = UTC 08:30)
    - cron: '30 8 * * 1-5'
  
  # 2. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      start_date:
        description: 'å¼€å§‹æ—¥æœŸ (YYYY-MM-DD)'
        required: false
        default: ''
      end_date:
        description: 'ç»“æŸæ—¥æœŸ (YYYY-MM-DD)'
        required: false
        default: ''

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.10'
  SERVER_PATH: '/root/lightstock'

jobs:
  update-stock-data:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # æ­¥éª¤2: è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # æ­¥éª¤3: å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install baostock pandas pyarrow tqdm
      
      # æ­¥éª¤4: ä¸‹è½½æœ€æ–°æ•°æ®
      - name: ğŸ“Š ä¸‹è½½æœ€æ–°è‚¡ç¥¨æ•°æ®
        run: |
          echo "å¼€å§‹ä¸‹è½½æœ€æ–°æ•°æ®..."
          
          # å¦‚æœæ‰‹åŠ¨æŒ‡å®šäº†æ—¥æœŸ,ä½¿ç”¨æŒ‡å®šæ—¥æœŸ
          if [ -n "${{ github.event.inputs.start_date }}" ]; then
            python scripts/download_data_daily.py \
              --start_date "${{ github.event.inputs.start_date }}" \
              --end_date "${{ github.event.inputs.end_date }}"
          else
            # å¦åˆ™åªä¸‹è½½æœ€è¿‘5ä¸ªäº¤æ˜“æ—¥çš„æ•°æ®
            python scripts/download_data_daily.py --recent_days 5
          fi
      
      # æ­¥éª¤5: é…ç½®SSHå¯†é’¥
      - name: ğŸ”‘ é…ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      # æ­¥éª¤6: ä¸Šä¼ åˆ°æœåŠ¡å™¨
      - name: ğŸ“¤ ä¸Šä¼ æ•°æ®åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
        run: |
          echo "ä¸Šä¼ æ•°æ®åˆ°æœåŠ¡å™¨..."
          
          # åªä¸Šä¼ æ–°ä¸‹è½½çš„æ–‡ä»¶(æœ€è¿‘ä¿®æ”¹çš„)
          scp -i ~/.ssh/id_rsa -r \
            data/daily_parquet/*.parquet \
            root@${{ secrets.SERVER_IP }}:${{ env.SERVER_PATH }}/data/daily_parquet/
          
          echo "âœ… æ•°æ®ä¸Šä¼ å®Œæˆ!"
      
      # æ­¥éª¤7: éªŒè¯æœåŠ¡å™¨ç«¯æ•°æ®
      - name: âœ… éªŒè¯æœåŠ¡å™¨æ•°æ®
        run: |
          echo "éªŒè¯æœåŠ¡å™¨ç«¯æ•°æ®..."
          
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} << 'EOF'
            cd ${{ env.SERVER_PATH }}/data/daily_parquet/
            
            echo "ğŸ“Š æ•°æ®ç»Ÿè®¡:"
            echo "æ–‡ä»¶æ€»æ•°: $(ls -1 *.parquet 2>/dev/null | wc -l)"
            echo "æ€»å¤§å°: $(du -sh . | cut -f1)"
            echo "æœ€æ–°æ–‡ä»¶:"
            ls -lt *.parquet | head -5
          EOF
      
      # æ­¥éª¤8: å‘é€é€šçŸ¥ (å¯é€‰)
      - name: ğŸ“§ å‘é€æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… æ•°æ®æ›´æ–°æˆåŠŸ!"
          echo "æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤9: å¤±è´¥å¤„ç†
      - name: âŒ å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ æ•°æ®æ›´æ–°å¤±è´¥!"
          echo "å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‚®ä»¶æˆ–å…¶ä»–é€šçŸ¥æ–¹å¼
